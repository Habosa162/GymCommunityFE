<div class="chat-container">
  <div class="group-section">
    <h3><i class="fas fa-users"></i> Groups</h3>
    <div class="new-group-form">
      <input [(ngModel)]="newGroupName" placeholder="New group name" (keyup.enter)="createGroup()">
      <button (click)="createGroup()">
        <i class="fas fa-plus"></i>
      </button>
    </div>
    <ul class="groups-list">
      <li class="d-flex flex-column" *ngFor="let group of groups" 
          [class.selected]="group.groupId === selectedGroupId"
          (click)="selectGroup(group.groupId)">
        <span class="group-name">{{ parsePlanName(group.groupName) }}</span>
        <span *ngIf="authService.isLoggedIn() && authService.getUserRole() === 'Client'" class="group-name">
          {{ getCoachName(group.groupName) }}
        </span>
        <span *ngIf="authService.isLoggedIn() && authService.getUserRole() === 'Coach'" class="group-name">
          {{ getClientName(group.groupName) }}
        </span>
      </li>
      <li *ngIf="groups.length === 0" class="no-groups">
        <i class="fas fa-info-circle"></i> No groups available
      </li>
    </ul>
    <div class="debug-controls">
      <button (click)="inspectChatState()" class="debug-button" title="Inspect chat state in console">
        <i class="fas fa-bug"></i>
      </button>
    </div>
  </div>
  <div class="chat-section">
    <div class="messages-header" *ngIf="selectedGroupId">
      <h4>
        <span class="group-icon"><i class="fas fa-hashtag"></i></span>
        {{ getSelectedGroupName() }}
      </h4>
      <div class="connection-status" [class.connected]="isConnected">
        <i [class]="isConnected ? 'fas fa-circle-check' : 'fas fa-circle-exclamation'"></i>
        {{ isConnected ? 'Connected' : 'Connecting...' }}
      </div>
    </div>
    <div class="messages" #messagesContainer *ngIf="selectedGroupId; else noGroup">
      <div *ngFor="let message of messages" 
           [ngClass]="{'message-sent': isMessageFromCurrentUser(message), 'message-received': !isMessageFromCurrentUser(message)}">
        <ng-container *ngIf="!isMessageFromCurrentUser(message)">
          <div class="message-avatar">
            <img *ngIf="userAvatarCache[message.senderId]" [src]="userAvatarCache[message.senderId]" alt="Avatar" class="user-avatar">
            <i *ngIf="!userAvatarCache[message.senderId]" class="fas fa-user"></i>
          </div>
          <div class="message-content-wrapper">
            <div class="message-bubble">
              <p class="message-content">{{ message.content }}</p>
            </div>
            <div class="message-info">
              <small class="message-sender">
                {{ message.senderName || getUserName(message.senderId) }}
              </small>
              <small class="message-time">
                <i class="far fa-clock"></i> {{ message.timestamp | date:'short' }}
              </small>
            </div>
          </div>
        </ng-container>
        <ng-container *ngIf="isMessageFromCurrentUser(message)">
          <div class="message-bubble">
            <p class="message-content">{{ message.content }}</p>
          </div>
          <div class="message-info">
            <small class="message-time">
              <i class="far fa-clock"></i> {{ message.timestamp | date:'short' }}
            </small>
            <small class="message-status">
              <i class="fas fa-check"></i>
            </small>
          </div>
        </ng-container>
      </div>
      <div *ngIf="messages.length === 0" class="no-messages">
        <p><i class="far fa-comment-dots"></i> No messages yet</p>
        <p class="sub-message">Be the first one to send a message!</p>
      </div>
    </div>
    <ng-template #noGroup>
      <div class="select-group-prompt">
        <div class="prompt-content">
          <i class="far fa-comments icon-large"></i>
          <p>Select a group to start chatting</p>
        </div>
      </div>
    </ng-template>
    <div class="input-area" *ngIf="selectedGroupId">
      <input [(ngModel)]="newMessage" 
             (keyup.enter)="sendMessage()" 
             placeholder="Type a message..."
             [disabled]="!isConnected">
      <button (click)="sendMessage()" [disabled]="!isConnected || !newMessage.trim()">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
</div>